<%= render 'shared/navbar_app' %>
<div class="analysis-container">
  <div class="analysis-header">
 

    <h1 class="analysis-title">Nouvelle analyse de code</h1>
    <p class="analysis-subtitle">Analysez et améliorez votre code avec l'intelligence artificielle</p>
  </div>

  <%= form_with model: @analysis, local: true, multipart: true, data: { turbo: false } do |form| %>
    <div class="form-card">
      <!-- Titre du projet -->
      <div class="form-group">
        <%= form.label :title, "Nom du projet", class: "form-label" %>
        <%= form.text_field :title,
              class: "form-input",
              placeholder: "Ex: Mon application Rails...",
              autocomplete: "off" %>
      </div>

      <!-- Sélection du langage -->
      <div class="form-group">
        <%= form.label :language, "Langage de programmation", class: "form-label" %>
        <div class="select-wrapper">
          <%= form.select :language,
                ["Ruby", "Python", "JavaScript", "TypeScript", "HTML", "CSS", "SQL", "Java", "C++", "PHP", "Rust", "Go", "Bash"],
                {},
                class: "form-select" %>
          <svg class="select-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </div>
      </div>

      <!-- Tabs code / fichier -->
      <div class="form-group">
        <label class="form-label">Source du code</label>
        <div class="tab-container">
          <button type="button" id="text-tab" class="tab-button active">
            <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            <span>Coller du code</span>
          </button>
          <button type="button" id="file-tab" class="tab-button">
            <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            <span>Uploader un fichier</span>
          </button>
        </div>
      </div>

      <!-- Zone de texte -->
      <div id="text-mode" class="code-input-section">
        <div class="textarea-wrapper">
          <%= form.text_area :code,
                rows: 12,
                class: "code-textarea",
                placeholder: "// Collez votre code ici...\n// Minimum 10 caractères requis\n\nfunction example() {\n  console.log('Hello, World!');\n}" %>
          <div class="textarea-footer">
            <span id="char-count" class="char-counter">0 caractères</span>
          </div>
        </div>
        <div id="code-warning" class="warning-message">
          <svg class="warning-icon" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
          </svg>
          <span>Veuillez entrer au moins 10 caractères de code</span>
        </div>
      </div>

      <!-- Zone d'upload -->
<div id="file-mode" 
     class="file-upload-section" 
     style="display: none;" 
     data-controller="file-upload">
  
  <div id="drop-zone" 
       class="drop-zone"
       data-file-upload-target="dropZone"
       data-action="click->file-upload#openFileSelector
                    drop->file-upload#handleDrop
                    dragover->file-upload#handleDragOver
                    dragleave->file-upload#handleDragLeave">
    <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
    </svg>
    <p class="upload-title">Glissez-déposez votre fichier ici</p>
    <p class="upload-subtitle">ou <span class="upload-link" data-action="click->file-upload#openFileSelector">parcourir</span></p>
    <p class="upload-formats">Formats acceptés: .rb, .py, .js, .ts, .cpp, .java, .php, .go, .rs, .sql, .html, .css, .sh, .bash</p>
  </div>

  <%= form.file_field :uploaded_file,
        accept: ".rb,.py,.js,.ts,.cpp,.c,.java,.php,.go,.rs,.sql,.html,.css,.sh,.bash",
        style: "display: none;",
        id: "file-input",
        data: { 
          file_upload_target: "fileInput",
          action: "change->file-upload#handleFileChange"
        } %>

  <div id="file-preview" 
       class="file-preview"
       data-file-upload-target="filePreview">
    <div class="file-preview-content">
      <svg class="file-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
      </svg>
      <div class="file-info-wrapper">
        <p class="file-name" 
           id="file-info"
           data-file-upload-target="fileInfo"></p>
        <p class="file-status">Prêt pour l'analyse</p>
      </div>
      <button type="button" 
              id="remove-file" 
              class="remove-file-btn" 
              aria-label="Supprimer le fichier"
              data-action="click->file-upload#removeFile">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
  </div>
</div>

      <!-- Actions -->
      <div class="actions-section">
        <div class="actions-grid">
          <button type="submit" name="ai_provider" value="openai" class="action-button" data-color="#10b981">
            <i class="fa-solid fa-magnifying-glass"></i> Analyse rapide
          </button>

          <button type="submit" name="ai_provider" value="claude" class="action-button" data-color="#3b82f6">
            <i class="fa-solid fa-brain"></i> Analyse expert
          </button>

          <button type="submit" name="ai_provider" value="tests" class="action-button" data-color="#8b5cf6">
            <i class="fa-solid fa-list-check"></i> Tests automatiques
          </button>

          <button type="submit" name="ai_provider" value="smells" class="action-button" data-color="#f59e0b">
            <i class="fa-solid fa-triangle-exclamation"></i> Code smells
          </button>

          <button type="submit" name="ai_provider" value="improve" class="action-button action-button-wide" data-color="#ec4899">
            <i class="fa-solid fa-screwdriver-wrench"></i> Refactoring
          </button>
        </div>
      </div>
    </div>
  <% end %>
</div>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Inter',sans-serif;background:#fafafa;color:#0a0a0a;line-height:1.6;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
.analysis-container{max-width:840px;margin:0 auto;padding:3rem 1.5rem}

/* Header */
.analysis-header{text-align:center;margin-bottom:3.5rem}
.analysis-title{font-size:2.5rem;font-weight:700;color:#0a0a0a;margin-bottom:.75rem;letter-spacing:-.02em}
.analysis-subtitle{font-size:1.125rem;color:#6b7280;font-weight:400}

/* Card */
.form-card{background:#fff;border-radius:20px;padding:3rem;box-shadow:0 4px 25px rgba(0,0,0,.08);border:1px solid #e5e7eb}
.form-group{margin-bottom:2.5rem}
.form-group:last-child{margin-bottom:0}

/* Labels + inputs */
.form-label{display:block;font-size:.9375rem;font-weight:600;color:#1f2937;margin-bottom:.75rem}
.form-input,.form-select{width:100%;padding:.875rem 1.125rem;font-size:.9375rem;border:1.5px solid #e5e7eb;border-radius:12px;background:#fff;color:#0a0a0a;transition:all .2s ease}
.form-input:focus,.form-select:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 4px rgba(59,130,246,.08)}
.form-input::placeholder{color:#9ca3af}

/* Select */
.select-wrapper{position:relative}
.form-select{appearance:none;padding-right:2.75rem;cursor:pointer}
.select-icon{position:absolute;right:1.125rem;top:50%;transform:translateY(-50%);width:20px;height:20px;color:#6b7280;pointer-events:none}

/* Tabs */
.tab-container{display:flex;gap:.5rem;padding:.375rem;background:#f8fafc;border-radius:12px;border:1.5px solid #e2e8f0}
.tab-button{flex:1;display:flex;align-items:center;justify-content:center;gap:.625rem;padding:.875rem 1.125rem;background:transparent;border:1px solid transparent;border-radius:10px;font-size:.875rem;font-weight:500;color:#64748b;cursor:pointer;transition:all .2s ease;position:relative;overflow:hidden}
.tab-button::before{content:'';position:absolute;inset:0;padding:1px;background:linear-gradient(45deg,#ff6b6b,#4ecdc4,#45b7d1,#96ceb4,#ffeaa7,#dda0dd,#98d8c8);background-size:400% 400%;border-radius:10px;opacity:0;transition:all .3s ease;animation:gradientShift 3s ease infinite;mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);mask-composite:xor;-webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor}
.tab-button:hover::before{opacity:1}
.tab-button:hover{background:#fff;color:#1e293b;transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
.tab-button.active{background:#fff;color:#1e293b;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.tab-icon{width:18px;height:18px}
@keyframes gradientShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

/* Code textarea */
.code-input-section{margin-top:1.75rem}
.textarea-wrapper{position:relative}
.code-textarea{width:100%;min-height:320px;padding:1.125rem;font-family:'SF Mono',Monaco,'Cascadia Code','Roboto Mono',monospace;font-size:.875rem;line-height:1.6;background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:12px;color:#1e293b;resize:vertical;transition:all .2s ease}
.code-textarea:focus{outline:none;border-color:#3b82f6;background:#fff;box-shadow:0 0 0 4px rgba(59,130,246,.08)}
.textarea-footer{margin-top:.625rem;display:flex;justify-content:flex-end}
.char-counter{font-size:.75rem;color:#94a3b8;font-weight:500}

/* Warning */
.warning-message{display:none;align-items:center;gap:.625rem;margin-top:.875rem;padding:.875rem 1.125rem;background:#fef2f2;border:1.5px solid #fecaca;border-radius:10px;color:#dc2626;font-size:.875rem;font-weight:500}
.warning-icon{width:20px;height:20px;flex-shrink:0}

/* Upload */
.file-upload-section{margin-top:1.75rem}
.drop-zone{padding:3.5rem 2.5rem;border:2px dashed #cbd5e1;border-radius:16px;text-align:center;cursor:pointer;transition:all .25s ease;background:#f8fafc;position:relative;overflow:hidden}
.drop-zone::before{content:'';position:absolute;inset:0;padding:2px;background:linear-gradient(45deg,#ff6b6b,#4ecdc4,#45b7d1,#96ceb4,#ffeaa7,#dda0dd,#98d8c8);background-size:400% 400%;border-radius:16px;opacity:0;transition:all .3s ease;animation:gradientShift 3s ease infinite;mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);mask-composite:xor;-webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor}
.drop-zone:hover::before{opacity:1}
.drop-zone:hover{border:2px solid transparent;background:#f0f9ff;transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
.drop-zone.drag-over{border-color:#3b82f6;background:#eff6ff;transform:scale(1.02)}
.drop-zone.drag-over::before{opacity:0}
.upload-icon{width:52px;height:52px;margin:0 auto 1.25rem;color:#94a3b8}
.upload-title{font-size:1.0625rem;font-weight:600;color:#334155;margin-bottom:.375rem}
.upload-subtitle{font-size:.9375rem;color:#64748b;margin-bottom:.625rem}
.upload-link{color:#3b82f6;font-weight:600;cursor:pointer}
.upload-link:hover{text-decoration:underline}
.upload-formats{font-size:.8125rem;color:#94a3b8}

/* File preview */
.file-preview{display:none;margin-top:1.125rem;padding:1.125rem;background:#f0fdf4;border:1.5px solid #bbf7d0;border-radius:12px}
.file-preview-content{display:flex;align-items:center;gap:1.125rem}
.file-icon{width:36px;height:36px;color:#10b981;flex-shrink:0}
.file-info-wrapper{flex:1}
.file-name{font-weight:600;color:#0f172a;margin-bottom:.1875rem}
.file-status{font-size:.875rem;color:#10b981;font-weight:500}
.remove-file-btn{padding:.625rem;background:#fff;border:1.5px solid #e2e8f0;border-radius:10px;color:#64748b;cursor:pointer;transition:all .2s ease}
.remove-file-btn:hover{background:#fee2e2;border-color:#fecaca;color:#ef4444}

/* Actions */
.actions-section{margin-top:1.5rem}
.actions-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1.125rem}
.action-button{display:flex;align-items:center;justify-content:center;gap:.75rem;padding:1.125rem 1.5rem;background:#fff;border:1.5px solid #e2e8f0;border-radius:12px;font-size:.9375rem;font-weight:600;color:#334155;cursor:pointer;transition:all .25s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.05)}
.action-button::before{content:'';position:absolute;inset:0;background:currentColor;opacity:0;transition:opacity .25s ease}
.action-button:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(0,0,0,.12)}
.action-button:hover::before{opacity:.06}
.action-button:active{transform:translateY(-1px)}
.action-button-wide{grid-column:1 / -1}
.action-button i{font-size:1rem;color:inherit;transition:all .25s ease}

/* === Loading overlay (simple & honnête, sans ETA) === */
.loading-overlay{display:none;position:fixed;inset:0;background:rgba(255,255,255,.96);backdrop-filter:blur(10px);z-index:9999}
.loading-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:left}
.loading-card{background:#fff;border:1px solid #e5e7eb;border-radius:20px;padding:28px;width:min(620px,92vw);box-shadow:0 30px 80px rgba(0,0,0,.12)}
.loading-title{font-size:1.35rem;font-weight:800;color:#0f172a;margin:0 0 6px}
.loading-subcopy{font-size:.98rem;color:#64748b;margin:0 0 16px}

/* Barre globale indéterminée */
.loading-progress-track{
  position:relative;
  width:100%;
  height:12px;
  border-radius:999px;
  overflow:hidden;
  background:linear-gradient(180deg,#eef2f7 0%,#e9edf3 100%);
  box-shadow:inset 0 1px 2px rgba(0,0,0,.05);
}
.loading-progress-bar{
  position:absolute;
  top:0;
  bottom:0;
  left:-30%;
  width:30%;
  border-radius:inherit;
  background:linear-gradient(90deg,#60a5fa 0%,#3b82f6 60%,#2563eb 100%);
  animation:progressIndeterminate 1.2s ease-in-out infinite;
}
@keyframes progressIndeterminate{
  0%   { left:-30%; width:30%; }
  50%  { left:25%;  width:55%; }
  100% { left:100%; width:30%; }
}

/* Responsive */
@media (max-width:640px){
  .analysis-container{padding:2rem 1rem}
  .analysis-title{font-size:2.125rem}
  .form-card{padding:2.25rem}
  .actions-grid{grid-template-columns:1fr}
  .code-textarea{min-height:260px}
  .actions-section{margin-top:1.25rem}
}

</style>

<script>
(function() {
  function initAnalysisPage(){
    // Juste les fonctionnalités de base sans l'upload
    const form = document.querySelector("form");
    const codeField = document.querySelector("textarea#analysis_code");
    const charCounter = document.querySelector("#char-count");
    const textTab = document.querySelector("#text-tab");
    const fileTab = document.querySelector("#file-tab");
    const textMode = document.querySelector("#text-mode");
    const fileMode = document.querySelector("#file-mode");
    const actionButtons = document.querySelectorAll('.action-button');

    // Hover colors
    actionButtons.forEach(button => {
      const color = button.dataset?.color;
      if(!color) return;
      button.addEventListener('mouseenter', function(){
        this.style.borderColor = color;
        this.style.color = color;
      });
      button.addEventListener('mouseleave', function(){
        this.style.borderColor = '#e2e8f0';
        this.style.color = '#334155';
      });
    });

    // Character counter
    if(codeField && charCounter){
      codeField.addEventListener('input', function(){
        const count = this.value.length;
        charCounter.textContent = `${count} caractères`;
        if(count > 0 && count < 10) charCounter.style.color = '#ef4444';
        else if(count >= 10) charCounter.style.color = '#10b981';
        else charCounter.style.color = '#94a3b8';
      });
    }

    // Tabs
    if(textTab && fileTab){
      textTab.addEventListener("click", () => {
        textTab.classList.add("active");
        fileTab.classList.remove("active");
        textMode.style.display = "block";
        fileMode.style.display = "none";
      });
      
      fileTab.addEventListener("click", () => {
        fileTab.classList.add("active");
        textTab.classList.remove("active");
        textMode.style.display = "none";
        fileMode.style.display = "block";
      });
    }

    // Loader
    if(form){
      form.addEventListener('submit', function(e){
        const overlay = document.createElement('div');
        overlay.className = 'loading-overlay';
        overlay.innerHTML = `
          <div class="loading-content">
            <div class="loading-card">
              <h2 class="loading-title">Analyse en cours…</h2>
              <p class="loading-subcopy">BugHound prépare votre rapport.</p>
              <div class="loading-progress-track">
                <div class="loading-progress-bar"></div>
              </div>
            </div>
          </div>`;
        overlay.style.display = 'flex';
        document.body.appendChild(overlay);
      });
    }
  }

  document.addEventListener("DOMContentLoaded", initAnalysisPage);
  document.addEventListener("turbo:load", initAnalysisPage);
})();
</script>