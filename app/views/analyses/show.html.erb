<div class="analysis-container">
  <!-- Header Card -->
  <div class="analysis-card">
    <div class="card-header">
      <h1 style="margin: 0; font-size: 1.5rem; color: #2d3748;"><%= @analysis.title %></h1>
    </div>
    <div class="card-content">
      <div style="display: flex; gap: 2rem; align-items: center; flex-wrap: wrap;">
        <div>
          <strong>Langage :</strong>
          <span style="background: #e2e8f0; padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 500;">
            <%= @analysis.language %>
          </span>
        </div>
        <div>
          <strong>Analys√© par :</strong>
          <% if @analysis.ai_provider == "claude" %>
            <span style="background: #fed7d7; color: #c53030; padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 500;">
              ‚ö° Claude (Expert)
            </span>
          <% elsif @analysis.ai_provider == "tests" %>
            <span style="background: #e9d8fd; color: #6b46c1; padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 500;">
              üìã Tests Automatiques
            </span>
          <% elsif @analysis.ai_provider == "improve" %>
            <span style="background: #fbb6ce; color: #be185d; padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 500;">
              ‚ú® Am√©lioration Auto
            </span>
          <% elsif @analysis.ai_provider == "smells" %>
            <span style="background: #fecaca; color: #dc2626; padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 500;">
              üëÉ Code Smells
            </span>
          <% else %>
            <span style="background: #d1fae5; color: #059669; padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 500;">
              ü§ñ OpenAI (Standard)
            </span>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Score Card (only for standard analyses) -->
  <% if @analysis.ai_provider.in?(["openai", "claude"]) && @score %>
    <div class="analysis-card">
      <div class="card-header">üìä Score Global</div>
      <div class="card-content">
        <div style="text-align: center; padding: 2rem;">
          <div style="background: <%= @score >= 8 ? '#d5f4e6' : @score >= 6 ? '#fff3cd' : '#f8d7da' %>;
                      color: <%= @score >= 8 ? '#27ae60' : @score >= 6 ? '#f39c12' : '#e74c3c' %>;
                      padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem;">
            <h2 style="font-size: 2rem; margin: 0 0 0.5rem 0;"><%= @score %>/10</h2>
            <p style="margin: 0; font-size: 1rem; opacity: 0.8;">
              <%= case @score
                  when 8..10 then "Excellent travail ! üéâ"
                  when 6..7 then "Bon code, quelques am√©liorations possibles üëç"
                  when 4..5 then "Code correct mais perfectible üîß"
                  else "Attention, des am√©liorations importantes sont n√©cessaires ‚ö†Ô∏è"
                  end %>
            </p>
          </div>
        </div>

        <!-- Detailed Scores -->
        <% if @scores.present? %>
          <h3 style="margin-bottom: 1rem;">üß™ D√©tail par cat√©gorie :</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
            <% @scores.each do |key, score| %>
              <% label = {
                security: "üõ°Ô∏è S√©curit√©",
                performance: "‚öôÔ∏è Performance",
                readability: "üìê Lisibilit√©",
                testing: "üß™ Tests"
              }[key] %>
              <% color = score <= 4 ? "#e74c3c" : score <= 7 ? "#f39c12" : "#27ae60" %>
              <div style="display: flex; align-items: center; padding: 1rem; border: 1px solid #e1e5e9; border-radius: 8px;">
                <div style="width: 12px; height: 12px; border-radius: 50%; background-color: <%= color %>; margin-right: 0.75rem;"></div>
                <div>
                  <strong><%= label %> :</strong>&nbsp;
                  <span style="color: <%= color %>; font-weight: 600;"><%= score %>/10</span>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Code Card -->
  <div class="analysis-card">
    <div class="card-header">üíª Code analys√©</div>
    <div class="card-content">
      <pre class="code-block"><code class="language-<%= @analysis.language.downcase %>"><%= @analysis.code %></code></pre>
    </div>
  </div>

  <!-- Analysis Results Card -->
  <% if @analysis.ai_feedback.present? %>
    <div class="analysis-card">
      <div class="card-header">
        <% if @analysis.ai_provider == "tests" %>
          üß™ Tests g√©n√©r√©s automatiquement
        <% elsif @analysis.ai_provider == "improve" %>
          ‚ú® Code am√©lior√© automatiquement
        <% elsif @analysis.ai_provider == "smells" %>
          üëÉ Code Smells d√©tect√©s
        <% else %>
          ü§ñ Retour de l'agent QA
        <% end %>
      </div>
      <div class="card-content">
        <div style="background: #f8f9fa; padding: 1.5rem; border-left: 4px solid #007bff; border-radius: 4px; font-family: system-ui; line-height: 1.6;">
          <%
            # Simple clean feedback - no complex parsing
            clean_feedback = @analysis.ai_feedback.to_s

            # For standard analyses, remove global score section
            if @analysis.ai_provider.in?(["openai", "claude"])
              clean_feedback = clean_feedback.gsub(/üìä.*?Score.*?\d{1,2}\/10.*?\n/mi, "")
              clean_feedback = clean_feedback.gsub(/üîß.*$/m, "")
            end

            clean_feedback = clean_feedback.strip
          %>
          <%= simple_format(clean_feedback, {}, wrapper_tag: "div") %>
        </div>
      </div>
    </div>

    <!-- Simple Correction Section -->
    <% if @analysis.ai_provider.in?(["openai", "claude"]) && @analysis.ai_feedback.include?("üîß") %>
      <div class="analysis-card">
        <div class="card-header">üîß Proposition de correction</div>
        <div class="card-content">
          <% correction_section = @analysis.ai_feedback.match(/üîß.*$/m) %>
          <% if correction_section %>
            <div style="background: #f4f6f6; padding: 1.5rem; border-left: 4px solid #5dade2; border-radius: 4px;">
              <%= simple_format(correction_section.to_s.strip, {}, wrapper_tag: "div") %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

  <% else %>
    <!-- Error Card -->
    <div class="analysis-card">
      <div class="card-content">
        <div style="background-color: #f8d7da; padding: 1.5rem; border-left: 5px solid #e74c3c; border-radius: 6px;">
          <h2 style="font-size: 1.4rem; font-weight: bold; margin-bottom: 0.6rem; color: #e74c3c;">
            ‚ö†Ô∏è Analyse √©chou√©e
          </h2>
          <p style="margin: 0.5rem 0; color: #721c24;">
            L'analyse IA n'a pas pu √™tre effectu√©e. Cela peut √™tre d√ª √† :
          </p>
          <ul style="color: #721c24; margin: 0.5rem 0; padding-left: 1.5rem;">
            <li>Fichier trop volumineux (> 1000 lignes)</li>
            <li>Probl√®me de connexion √† l'API</li>
            <li>Timeout de l'API</li>
            <li>Code dans un format non reconnu</li>
          </ul>
          <p style="margin: 0.5rem 0 0 0; color: #721c24;">
            <strong>Solution :</strong> Essayez avec un fichier plus petit ou collez directement le code.
          </p>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Navigation Buttons -->
  <div class="analysis-card">
    <div class="card-content">
      <div style="display: flex; gap: 1rem; justify-content: center;">
        <%= link_to "Nouvelle analyse", new_analysis_path,
            style: "text-decoration: none; background: #007bff; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; transition: all 0.2s;" %>
        <%= link_to "Voir toutes les analyses", analyses_path,
            style: "text-decoration: none; background: #6c757d; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; transition: all 0.2s;" %>
      </div>
    </div>
  </div>
</div>

<script>
// Initialize Prism.js for syntax highlighting
document.addEventListener('DOMContentLoaded', function() {
  if (window.Prism) {
    Prism.highlightAll();
  }
});
</script>
