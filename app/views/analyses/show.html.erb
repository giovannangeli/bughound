<div class="analysis-container-premium">
  <div class="analysis-card-premium">
    
    <!-- Header unifi√© avec partage -->
    <div class="analysis-header-premium">
      <div class="analysis-meta">
        <h1 class="analysis-title-premium"><%= @analysis.title %></h1>
        <div class="analysis-badges">
          <span class="lang-badge-premium"><%= @analysis.language %></span>
          <% if @analysis.ai_provider == "claude" %>
            <span class="provider-badge-premium claude">‚ö° Claude (Expert)</span>
          <% elsif @analysis.ai_provider == "tests" %>
            <span class="provider-badge-premium tests">üìã Tests Automatiques</span>
          <% elsif @analysis.ai_provider == "improve" %>
            <span class="provider-badge-premium improve">‚ú® Am√©lioration Auto</span>
          <% elsif @analysis.ai_provider == "smells" %>
            <span class="provider-badge-premium smells">üëÉ Code Smells</span>
          <% else %>
            <span class="provider-badge-premium openai">ü§ñ OpenAI (Standard)</span>
          <% end %>
        </div>
      </div>
      
      <!-- Bouton partage -->
      <div class="dropdown-container-premium" data-dropdown>
        <button class="btn-share-premium" data-dropdown-trigger>
          <i class="fas fa-share"></i>
          <span>Partager</span>
          <i class="fas fa-chevron-down dropdown-chevron"></i>
        </button>
        <div class="dropdown-menu-premium" data-dropdown-menu>
          <button class="dropdown-item-premium" onclick="copyAnalysisUrl()">
            <i class="fas fa-copy"></i>
            <span>Copier le lien</span>
          </button>
          <button class="dropdown-item-premium" onclick="downloadAnalysisPDF()">
            <i class="fas fa-file-pdf"></i>
            <span>T√©l√©charger PDF</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Score Hero (si applicable) -->
    <% if @analysis.ai_provider.in?(["openai", "claude", "tests", "smells"]) && @score %>
      <div class="score-section-premium">
        <div class="score-hero-premium">
          <div class="score-display-premium" data-score="<%= @score %>">
            <span class="score-number-premium"><%= @score %>/10</span>
            <span class="score-message-premium">
              <%= case @score
                  when 8..10 then "Excellent travail ! üéâ"
                  when 6..7 then "Bon code, quelques am√©liorations possibles üëç"
                  when 4..5 then "Code correct mais perfectible üîß"
                  else "Attention, des am√©liorations importantes sont n√©cessaires ‚ö†Ô∏è"
                  end %>
            </span>
          </div>
        </div>
        
        <!-- Scores d√©taill√©s horizontaux -->
        <% if @scores.present? %>
          <div class="scores-detail-premium">
            <% @scores.each do |key, score| %>
              <% label = {
                security: "üõ°Ô∏è S√©curit√©",
                performance: "‚öôÔ∏è Performance", 
                readability: "üìê Lisibilit√©",
                testing: "üß™ Tests"
              }[key] %>
              <div class="score-item-premium" data-score="<%= score %>">
                <span class="score-label-premium"><%= label %></span>
                <span class="score-value-premium"><%= score %>/10</span>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- Code collapsible -->
    <div class="code-section-premium">
      <button class="code-toggle-premium" onclick="toggleCode()">
        <i class="fas fa-code code-icon"></i>
        <span>Code analys√©</span>
        <i class="fas fa-chevron-down code-chevron"></i>
      </button>
      <div class="code-content-premium" style="display: none;">
        <pre class="code-block"><code class="language-<%= @analysis.language.downcase %>"><%= @analysis.code %></code></pre>
      </div>
    </div>

    <!-- Feedback Section -->
    <% if @analysis.ai_feedback.present? %>
      <div class="feedback-section-premium">
        <h3 class="feedback-title-premium">
          <% if @analysis.ai_provider == "tests" %>
            üß™ Tests g√©n√©r√©s automatiquement
          <% elsif @analysis.ai_provider == "improve" %>
            ‚ú® Code am√©lior√© automatiquement
          <% elsif @analysis.ai_provider == "smells" %>
            üëÉ Code Smells d√©tect√©s
          <% else %>
            ü§ñ Retour de l'agent QA
          <% end %>
        </h3>
        <div class="feedback-content-premium">
          <%
            # Clean feedback comme dans ton code existant
            clean_feedback = @analysis.ai_feedback.to_s
            if @analysis.ai_provider.in?(["openai", "claude"])
              clean_feedback = clean_feedback.gsub(/üìä.*?Score.*?\d{1,2}\/10.*?\n/mi, "")
              clean_feedback = clean_feedback.gsub(/üîß.*$/m, "")
            end
            clean_feedback = clean_feedback.strip
          %>
          <%= simple_format(clean_feedback, {}, wrapper_tag: "div") %>
        </div>
      </div>

      <!-- Correction Section -->
      <% if @analysis.ai_provider.in?(["openai", "claude"]) && @analysis.ai_feedback.include?("üîß") %>
        <div class="correction-section-premium">
          <h3 class="correction-title-premium">üîß Proposition de correction</h3>
          <div class="correction-content-premium">
            <% correction_section = @analysis.ai_feedback.match(/üîß.*$/m) %>
            <% if correction_section %>
              <%= simple_format(correction_section.to_s.strip, {}, wrapper_tag: "div") %>
            <% end %>
          </div>
        </div>
      <% end %>

    <% else %>
      <!-- Error Section -->
      <div class="error-section-premium">
        <div class="error-content-premium">
          <h3 class="error-title-premium">‚ö†Ô∏è Analyse √©chou√©e</h3>
          <p>L'analyse IA n'a pas pu √™tre effectu√©e. Cela peut √™tre d√ª √† :</p>
          <ul>
            <li>Fichier trop volumineux (> 1000 lignes)</li>
            <li>Probl√®me de connexion √† l'API</li>
            <li>Timeout de l'API</li>
            <li>Code dans un format non reconnu</li>
          </ul>
          <p><strong>Solution :</strong> Essayez avec un fichier plus petit ou collez directement le code.</p>
        </div>
      </div>
    <% end %>

    <!-- Navigation Buttons -->
    <div class="navigation-premium">
      <%= link_to "Nouvelle analyse", new_analysis_path, class: "btn-primary-premium" %>
      <%= link_to "Voir toutes les analyses", analyses_path, class: "btn-secondary-premium" %>
    </div>

  </div>
</div>

<script>
// Code collapsible toggle
function toggleCode() {
  const content = document.querySelector('.code-content-premium');
  const chevron = document.querySelector('.code-chevron');
  
  if (content.style.display === 'none') {
    content.style.display = 'block';
    chevron.style.transform = 'rotate(180deg)';
  } else {
    content.style.display = 'none';
    chevron.style.transform = 'rotate(0deg)';
  }
}

// Dropdown functionality (r√©utilise ton code existant)
document.addEventListener('click', function(e) {
  if (e.target.closest('[data-dropdown-trigger]')) {
    e.preventDefault();
    e.stopPropagation();
    
    const dropdown = e.target.closest('[data-dropdown]');
    const isOpen = dropdown.classList.contains('open');
    
    document.querySelectorAll('[data-dropdown]').forEach(d => {
      d.classList.remove('open');
    });
    
    if (!isOpen) {
      dropdown.classList.add('open');
    }
    return;
  }
  
  if (!e.target.closest('[data-dropdown]')) {
    document.querySelectorAll('[data-dropdown]').forEach(d => {
      d.classList.remove('open');
    });
  }
});

// Fonctions de partage (√† adapter avec tes variables)
function copyAnalysisUrl() {
  const currentUrl = window.location.href;
  navigator.clipboard.writeText(currentUrl).then(() => {
    // Feedback visuel
    const button = document.querySelector('.dropdown-item-premium');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i><span>Lien copi√© !</span>';
    setTimeout(() => {
      button.innerHTML = originalText;
    }, 2000);
  });
}

function downloadAnalysisPDF() {
  const analysisId = '<%= @analysis.id %>';
  window.open(`/analyses/${analysisId}/download_pdf.pdf`, '_blank');
}

// Initialize Prism.js for syntax highlighting
document.addEventListener('DOMContentLoaded', function() {
  if (window.Prism) {
    Prism.highlightAll();
  }
});
</script>